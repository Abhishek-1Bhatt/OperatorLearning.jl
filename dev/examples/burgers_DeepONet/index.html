<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Burgers Equation with DeepONet · OperatorLearning.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://pzimbrod.github.io/OperatorLearning.jl/examples/burgers_DeepONet/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><script src="../../../copy.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="OperatorLearning.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OperatorLearning.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../burgers_FNO/">Burgers Equation with FNO</a></li><li class="is-active"><a class="tocitem" href>Burgers Equation with DeepONet</a></li></ul></li><li><a class="tocitem" href="../../faq/">Frequently Asked Questions</a></li><li><a class="tocitem" href="../../reference/">Module Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Burgers Equation with DeepONet</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Burgers Equation with DeepONet</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/pzimbrod/OperatorLearning.jl/blob/master/docs/src/examples/burgers_DeepONet.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Solving-the-Burgers-Equation-with-DeepONet"><a class="docs-heading-anchor" href="#Solving-the-Burgers-Equation-with-DeepONet">Solving the Burgers Equation with DeepONet</a><a id="Solving-the-Burgers-Equation-with-DeepONet-1"></a><a class="docs-heading-anchor-permalink" href="#Solving-the-Burgers-Equation-with-DeepONet" title="Permalink"></a></h1><p>This example mostly adapts the original work by <a href="https://github.com/zongyi-li/fourier_neural_operator/blob/master/fourier_1d.py">Li et al</a> to solving with DeepONet and is intended to provide an analogue to <a href="../burgers_FNO/">the FNO example</a>.</p><p>We try to create an operator for the Burgers equation</p><p class="math-container">\[\partial_t u(x,t) + \partial_x (u^2(x,t)/2) = \nu \partial_{xx} u(x,t)\]</p><p>in one dimension for a unit spacial and temporal domain. The operator maps the initial condition <span>$u(x,0) = u_0(x)$</span> to the flow field at the final time <span>$u(x,1)$</span>.</p><p>So overall, we need an approximation function that does the following:</p><pre><code class="language-julia hljs">function foo(u0,x)
    # Do something
    return u1</code></pre><p>We sample from a dataset that contains several instances of the initial condition (<code>a</code>) and the final velocity field (<code>u</code>). The data is given on a grid of 8192 points, however we would like to only sample 1024 points.</p><pre><code class="language-julia hljs">using Flux: length, reshape, train!, throttle, @epochs
using OperatorLearning, Flux, MAT

device = cpu;

#=
We would like to implement and train a DeepONet that infers the solution
u(x) of the burgers equation on a grid of 1024 points at time one based
on the initial condition a(x) = u(x,0)
=#

# Read the data from MAT file and store it in a dict
# key &quot;a&quot; is the IC
# key &quot;u&quot; is the desired solution at time 1
vars = matread(&quot;burgers_data_R10.mat&quot;) |&gt; device

# For trial purposes, we might want to train with different resolutions
# So we sample only every n-th element
subsample = 2^3;

# create the x training array, according to our desired grid size
xtrain = vars[&quot;a&quot;][1:1000, 1:subsample:end]&#39; |&gt; device;
# create the x test array
xtest = vars[&quot;a&quot;][end-99:end, 1:subsample:end]&#39; |&gt; device;

# Create the y training array
ytrain = vars[&quot;u&quot;][1:1000, 1:subsample:end] |&gt; device;
# Create the y test array
ytest = vars[&quot;u&quot;][end-99:end, 1:subsample:end] |&gt; device;</code></pre><p>One particular thing to note here is that we need to permute the array containing the initial condition so that the inner product of DeepONet works. This is because we need to do the following contraction:</p><p class="math-container">\[\sum\limits_i t_{ji} b_{ik} = u_{jk}\]</p><p>For now, we only have one input and one output array. In addition, we need another input array that provides the probing locations for the operator <span>$u_1(x) = \mathcal{G}(u_0)(x)$</span>. In theory, we could choose those arbitrarily. For sake of simplicity though, we simply create the same equispaced grid that the original data was sampled from, i.e. a 1-D grid of 1024 equispaced points in [0;1]. Again, we need to transpose the array so that the array dim that is transformed by the trunk network is in the first column - otherwise the inner product would be much more cumbersome to handle.</p><pre><code class="language-julia hljs"># The data is missing grid data, so we create it
# `collect` converts data type `range` into an array
grid = collect(range(0, 1, length=1024))&#39; |&gt; device</code></pre><p>We can now set up the DeepONet. We choose the latent space to have dimensionality 1024 and use the vanilla DeepONet architecture, i.e. we use <code>Dense</code> layers in both branch and trunk net. Both contain two layers and use the GeLU activation function:</p><pre><code class="language-julia hljs"># Create the DeepONet:
# IC is given on grid of 1024 points, and we solve for a fixed time t in one
# spatial dimension x, making the branch input of size 1024 and trunk size 1
# We choose GeLU activation for both subnets
model = DeepONet((1024,1024,1024),(1,1024,1024),gelu,gelu) |&gt; device</code></pre><p>The rest is more or less boilerplate training code for a DNN, <em>with one exception</em>: For the loss to compute properly, we need to pass two separate input arrays for the branch and trunk network each. We employ the ADAM optimizer with a fixed learning rate of 1e-3, use the mean squared error as loss, evaluate the test loss as callback and train the FNO for 500 epochs.</p><pre><code class="language-julia hljs"># We use the ADAM optimizer for training
learning_rate = 0.001
opt = ADAM(learning_rate)

# Specify the model parameters
parameters = params(model)

# The loss function
# We can&#39;t use the &quot;vanilla&quot; implementation of the mse here since we have
# two distinct inputs to our DeepONet, so we wrap them into a tuple
loss(xtrain,ytrain,sensor) = Flux.Losses.mse(model(xtrain,sensor),ytrain)

# Define a callback function that gives some output during training
evalcb() = @show(loss(xtest,ytest,grid))
# Print the callback only every 5 seconds
throttled_cb = throttle(evalcb, 5)

# Do the training loop
Flux.@epochs 500 train!(loss, parameters, [(xtrain,ytrain,grid)], opt, cb = evalcb)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../burgers_FNO/">« Burgers Equation with FNO</a><a class="docs-footer-nextpage" href="../../faq/">Frequently Asked Questions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.12 on <span class="colophon-date" title="Wednesday 9 February 2022 12:53">Wednesday 9 February 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
